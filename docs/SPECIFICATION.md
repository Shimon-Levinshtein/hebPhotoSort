# 📸 HebPhotoSort - מערכת מיון תמונות/וידאו

## סקירה כללית
אפליקציית ווב (React + Node) למיון תמונות/וידאו אוטומטי/ידני. המשתמש מזין תיקיית מקור ותיקיית יעד, והשרת מסייע במיון המדיה.

### 🌟 פיצ'ר מרכזי: מיון לפי תאריך עברי
- המערכת קוראת את **תאריך יצירת המדיה**: EXIF לתמונות, מטא-נתוני קובץ/מערכת לוידאו
- ממירה את התאריך הלועזי ל**תאריך עברי**
- יוצרת תיקיות לפי תאריך עברי (חודש/שנה או יום/חודש/שנה)
- דוגמה: `כסלו תשפ"ה` או `כ"ה כסלו תשפ"ה`

---

## 🏗️ ארכיטקטורה

### Stack טכנולוגי
| שכבה | טכנולוגיה |
|------|-----------|
| Frontend | React 18+ |
| UI Components | shadcn/ui + Radix UI |
| Styling | Tailwind CSS |
| Build Tool | Vite |
| Backend API | Node.js + Express |
| File System | Node.js fs/path modules |
| Hebrew Calendar | @hebcal/core |
| EXIF Reading | exif-parser |
| Face Detection | face-api.js + TensorFlow.js |
| Image Processing | sharp |

### מבנה הפרויקט
```
hebPhotoSort/
├── docs/                      # תיעוד ואיפיון
│   ├── SPECIFICATION.md
│   ├── TASKS.md
│   └── AI_GUIDELINES.md
├── client/                    # Frontend (React + Vite + Tailwind + shadcn/ui)
│   ├── src/
│   │   ├── components/
│   │   │   ├── ui/              # shadcn components
│   │   │   ├── FolderPicker.jsx
│   │   │   ├── ImageGrid.jsx
│   │   │   ├── ImagePreview.jsx
│   │   │   ├── SortingControls.jsx
│   │   │   └── ProgressBar.jsx
│   │   ├── hooks/
│   │   │   ├── useApi.js
│   │   ├── lib/
│   │   │   ├── utils.js
│   │   ├── pages/
│   │   │   ├── Home.jsx
│   │   │   ├── FaceSearchPage.jsx
│   │   │   └── Settings.jsx
│   │   ├── store/
│   │   │   └── appStore.js      # Zustand store
│   │   ├── App.jsx
│   │   ├── main.jsx
│   │   └── index.css
│   ├── public/
│   ├── tailwind.config.js
│   ├── postcss.config.js
│   ├── vite.config.js
│   └── package.json
├── server/                    # Backend (Node/Express)
│   ├── src/
│   │   ├── index.js           # Entry point + Express setup
│   │   ├── routes/
│   │   │   ├── index.js       # Main routes (scan/sort/delete/create/exif)
│   │   │   ├── faces.js       # Face search routes (SSE streaming)
│   │   │   └── duplicates.js  # Duplicate detection routes
│   │   └── services/
│   │       ├── faceService.js # Face detection + clustering + caching
│   │       ├── fileService.js # File operations
│   │       └── posterService.js # Video poster generation
│   └── package.json
└── README.md
```

---

## 🎯 פיצ'רים

- [x] בחירת תיקיית מקור (הזנת נתיב)
- [x] בחירת תיקיית יעד (הזנת נתיב)
- [x] הצגת תמונות/וידאו מתיקיית המקור בגריד (וידאו כולל טעינת Range)
- [x] תצוגה מקדימה של תמונה/וידאו בודד + fallback פוסטר מ-ffmpeg-static כאשר ניגון לא נתמך
- [x] **קריאת תאריך יצירת תמונה מ-EXIF / וידאו ממטא־נתוני קובץ**
- [x] **המרת תאריך לועזי לתאריך עברי**
- [x] **יצירת תיקיות לפי תאריך עברי (חודש/שנה)**
- [x] העברת/העתקת קובץ מדיה לתיקיית היעד
- [x] מעבר בין פריטי מדיה (הבא/הקודם)
- [x] מונה התקדמות

### Phase 2 - שיפורים
- [x] מיון אוטומטי - כל התמונות בלחיצה אחת
- [x] בחירת פורמט תאריך עברי (חודש-שנה / יום-חודש-שנה)
- [ ] סימון מרובה (multi-select)
- [ ] פעולות batch (העברה/מחיקה מרובה)
- [ ] Undo/Redo

### Phase 3 - פיצ'רים מתקדמים
- [x] זיהוי כפילויות (תמונות + וידאו): hash חזותי (dHash) לתמונות ולפריים מייצג בוידאו, כולל יצירת פוסטר לתצוגה
- [x] **חיפוש לפי פנים**: זיהוי פנים וקיבוץ לפי אנשים (face-api.js)
  - [x] עדכון JSON בזמן אמת - כל קובץ שמסתיים נשמר מיד
  - [x] הצגה מיידית - פנים מוצגות במסך תוך כדי סריקה
  - [x] עצירה והמשכה - ניתן לעצור באמצע והסריקה תמשיך מאותה נקודה
  - [x] Cache חכם - קבצים שכבר נסרקו לא נסרקים שוב
- [ ] מיון לפי מיקום (GPS מ-EXIF)
- [ ] חיפוש וסינון לפי תאריך עברי
- [ ] שמירת פרופילי מיון
- [ ] תמיכה בחגים עבריים (סימון מיוחד)

---

## 🖥️ ממשק משתמש (UI/UX)

### מסך ראשי
```
┌─────────────────────────────────────────────────────────────┐
│  HebPhotoSort                                    [_][□][X]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │ 📁 תיקיית מקור      │  │ 📁 תיקיית יעד       │          │
│  │ C:\Photos\Unsorted  │  │ C:\Photos\Sorted    │          │
│  │ [בחר תיקייה]        │  │ [בחר תיקייה]        │          │
│  └─────────────────────┘  └─────────────────────┘          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │              [תצוגה מקדימה של תמונה]               │   │
│  │                                                     │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📅 תאריך צילום: כ״ד כסלו תשפ״ה  (25/12/2024)     │   │
│  │  📁 יועבר ל: כסלו תשפה                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│     [◀ הקודם]    12/156    [הבא ▶]                        │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ [🗑️ מחק] [📋 העתק] [📦 העבר] [📦 מיין אוטומטי]     │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌──┐┌──┐┌──┐┌──┐┌──┐┌──┐┌──┐┌──┐  (גריד תמונות ממוזער)  │
│  └──┘└──┘└──┘└──┘└──┘└──┘└──┘└──┘                          │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  ⏳ התקדמות: ████████░░░░░░░░ 52%  |  78 מיונו | 72 נותרו │
└─────────────────────────────────────────────────────────────┘
```

### עיצוב
- **Theme**: Dark mode כברירת מחדל
- **Colors**: גווני כחול-סגול (מודרני)
- **Typography**: פונט Heebo לעברית
- **Direction**: RTL support מלא
- **Animations**: Framer Motion לאנימציות חלקות

### מסך חיפוש לפי פנים
```
┌─────────────────────────────────────────────────────────────┐
│  📁 תיקיית מקור לפנים: [C:\Photos\Family    ] [בחר]        │
├─────────────────────────────────────────────────────────────┤
│  [⏹ עצור סריקה]  12 קבוצות · 45 תמונות    חיפוש: [____]   │
│  ════════════════════════════════════ 75%                   │
│  ⚡ 50 מהמטמון (כבר נסרקו)  🔍 25/100 חדשים                 │
│  📄 IMG_1234.jpg                                            │
│  💡 ניתן לעצור בכל רגע - הסריקה תמשיך מאותה נקודה          │
├─────────────────────────────────────────────────────────────┤
│  פרצופים (12 מוצגים)       │  תמונות לפי הפרצוף הנבחר      │
│  ┌────┐ ┌────┐ ┌────┐      │  ┌──┐┌──┐┌──┐┌──┐┌──┐         │
│  │ 👤 │ │ 👤 │ │ 👤 │      │  └──┘└──┘└──┘└──┘└──┘         │
│  │#1  │ │#2  │ │#3  │      │  ┌──┐┌──┐┌──┐┌──┐┌──┐         │
│  │45  │ │32  │ │28  │      │  └──┘└──┘└──┘└──┘└──┘         │
│  └────┘ └────┘ └────┘      │                               │
└─────────────────────────────────────────────────────────────┘
```

**תכונות מרכזיות:**
- **הצגה מיידית**: פנים מופיעות על המסך ברגע שהן מזוהות
- **עצירה והמשכה**: כפתור עצירה + המשכה מהנקודה האחרונה
- **מטמון חכם**: קבצים שנסרקו נשמרים ב-JSON, לא נסרקים שוב
- **התקדמות מפורטת**: אחוזים, מספר קבצים מהמטמון, קבצים חדשים

---

## 📅 מיון לפי תאריך עברי

### תהליך המיון
```
1. קריאת EXIF מהתמונה
   └── חילוץ DateTimeOriginal או CreateDate
   
2. המרה לתאריך עברי
   └── שימוש ב-@hebcal/core
   
3. יצירת מבנה תיקיות
   └── תיקיית יעד/שנה עברית/חודש עברי/
   
4. העברת/העתקת התמונה
```

### פורמטים נתמכים
| פורמט | דוגמה | מבנה תיקיות |
|-------|-------|-------------|
| חודש-שנה | כסלו תשפ"ה | `2024/כסלו תשפה/` |
| יום-חודש-שנה | כ"ה כסלו תשפ"ה | `2024/כסלו תשפה/כה כסלו/` |

### קריאת תאריך מתמונה
```javascript
// סדר עדיפות לקריאת תאריך:
1. EXIF.DateTimeOriginal    // תאריך הצילום המקורי
2. EXIF.CreateDate          // תאריך יצירה
3. EXIF.ModifyDate          // תאריך עריכה
4. File.birthtime           // תאריך יצירת הקובץ (fallback)
```

### דוגמה להמרה
```javascript
// Input:  2024-12-25 14:30:00
// Output: { 
//   hebrew: "כ״ד כסלו תשפ״ה",
//   year: "תשפ״ה",
//   month: "כסלו", 
//   day: "כ״ד",
//   folderName: "כסלו תשפה"
// }
```

### טיפול במקרי קצה
- **אין EXIF**: שימוש בתאריך יצירת הקובץ
- **תאריך לא תקין**: שאל את המשתמש או העבר לתיקיית "לא ידוע"
- **תמונה ללא תאריך**: אפשרות להזנה ידנית

---

## 🔧 API HTTP (Node/Express)

### Endpoints

| Method | Path | Body/Query | Description |
|--------|------|------------|-------------|
| POST | `/api/scan` | `{ sourcePath }` | סריקת תיקייה, החזרת רשימת תמונות ו-count |
| POST | `/api/sort` | `{ src, destRoot, format, mode }` | מיון/העתקה לפי תאריך עברי, יצירת תיקיות יעד |
| POST | `/api/delete` | `{ targetPath }` | מחיקת קובץ |
| POST | `/api/create-folder` | `{ targetPath }` | יצירת תיקייה |
| POST | `/api/exif` | `{ targetPath }` | קריאת תאריך EXIF והמרה לעברי |
| GET  | `/api/faces/scan-stream` | `?sourcePath=...` | סריקת פנים עם SSE (עדכונים בזמן אמת) |
| GET  | `/api/health` | - | בדיקת חיים |

### Face Search SSE Events
הסריקת פנים משתמשת ב-Server-Sent Events (SSE) לעדכונים בזמן אמת:

| Event | Data | Description |
|-------|------|-------------|
| `message` | `{ phase, current, total, message, ... }` | עדכון התקדמות |
| `faces` | `{ faces: [...], total, current }` | עדכון פנים שנמצאו (מיידי) |
| `result` | `{ faces, totalFiles, cacheStats }` | תוצאה סופית |
| `error` | `{ error, code }` | שגיאה |
| `close` | `{}` | סיום החיבור |

### Face Search Cache
קובץ `.hebphotosort-faces.json` נשמר בתיקיית המקור ומכיל:
```json
{
  "version": 1,
  "lastScan": "2024-01-01T12:00:00.000Z",
  "files": {
    "path/to/image.jpg": {
      "mtime": 1234567890,
      "faces": [{ "descriptor": [...], "box": {...}, "thumbnail": "..." }]
    }
  }
}
```
- **Resume**: הקובץ נשמר כל 5 קבצים, מאפשר המשכה מנקודת עצירה
- **Cache Hit**: קבצים שלא השתנו (לפי mtime) נטענים מהמטמון

---

## 📋 דרישות מערכת

### Development
- Node.js 18+
- npm או yarn
- Windows 10/11

### Production
- Windows 10/11 (64-bit)
- 4GB RAM מינימום
- 100MB דיסק פנוי

---

## 🔐 אבטחה

- השרת ניגש רק לנתיבים שסופקו בבקשות
- אין גישה לאינטרנט לצורך המיון (offline-first)
- מומלץ להריץ לוקאלית, לא לחשוף לאינטרנט ציבורי

---

## 📦 Build & Distribution

### Build Commands
```bash
# Backend
cd server
npm install
npm run dev      # פיתוח
npm run start    # ריצה רגילה

# Frontend
cd client
npm install
npm run dev      # פיתוח
npm run build    # build לproduction
```

### Output
- `client/dist/` - Build סטטי לפרונט
- השרת רץ כ-Node (ללא מעטפת דסקטופ)

